{% extends '@YesknBlog/base.html.twig' %}

{% block main %}
    <div class="row">
        <div class="col-lg-12">
            <div class="panel-body" style="background: #fff;margin-bottom: 10px">
                <ul class="chat">
                    <li class="left clearfix user-meta">
                        <span class="chat-img pull-left">
                              <img src="{{ user.avatar }}" alt="User Avatar" class="img-circle" width="50" height="50">
                        </span>
                        <div class="chat-body clearfix">
                            <div class="header">
                                <strong class="primary-font home-name"><a
                                            href="{{ path('user_home', {username: user.username}) }}"
                                            data-pjax>{{ user.nickname }}</a></strong>
                                <small class="pull-right text-muted">
                                    <i class="fa fa-clock-o fa-fw"></i> 加入于{{ user.registerAt|date('Y-m-d H:i:s') }},
                                    第{{ user.id }}位Vmoex用户
                                </small>
                            </div>
                            <p>{{ user.remark|raw }}</p>
                            <br/>
                            {% if app.user != user %}
                                <button type="button" data-toggle="modal" data-target="#exampleModal"
                                        class="btn btn-warning btn-sm"><i class="fa fa-envelope"></i> 发送私信
                                </button>
                                <button type="button" id="follow-user" class="btn btn-outline btn-danger btn-sm"><i
                                            class="fa fa-heart"></i> {% if app.user in user.followers %}已经关注{% else %}特别关注{% endif %}
                                </button>
                                <button type="button" id="block-user" class="btn btn-outline btn-warning btn-sm"><i
                                            class="fa fa-lock"></i> 屏蔽此人
                                </button>
                            {% endif %}
                        </div>
                    </li>
                </ul>
            </div>

            <div class="panel panel-default">
                <div class="panel-heading">
                    {{ user.nickname }}发布的帖子
                </div>
                <div class="panel-body">
                    {% set posts = user.posts|slice(0, 20) %}
                    {% if posts is not empty %}
                        {% for post in posts %}
                            <article class="main home-article-main" style="position: relative">
                                <div class="col-md-12 post-info">
                                        <span class="item-small-title">
                                            <a data-pjax
                                               href="{{ path('yeskn_blog_show' , {'id' : post.id}) }}">{{ post.title }}</a>
                                        </span>
                                    <div class="post-meta">
                                        <span><i class="fa fa-clock-o"></i> {{ post.createdAt|date("Y-m-d") }}</span>
                                        <span><i class="fa fa-eye"></i> {{ post.views }}</span>
                                        {% if post.comments.count %}
                                            <span><i class="fa fa-commenting-o"></i> <a data-pjax
                                                                                        href="{{ path('yeskn_blog_show', {id:post.id}) }}#comments">{{ post.comments.count }}</a></span>
                                        {% endif %}
                                        {% if post.categories is not null %}
                                            <span><i class="fa  fa-folder-o"></i>
                                                {% for cat in post.categories %}
                                                    {{ cat.name }}
                                                {% endfor %}
                                </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </article>
                        {% endfor %}
                    {% else %}
                        {{ '暂时没有发布任何帖子。' }}
                    {% endif %}
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">
                    {{ user.nickname }}的回复
                </div>
                <div class="panel-body">
                    {% set comments = user.comments %}
                    {% if comments is not empty %}
                        <div class="container">
                            {% for comment in comments %}
                                <div class="row">
                                    <div class="col-md-12">
                                        {{ comment.createdAt| date('Y-m-d H:i:s') }} 发表在 <a data-pjax
                                                                                            href="{{ path('yeskn_blog_show', {id: comment.post.id}) }}">{{ comment.post.title }}</a>
                                        上：
                                        <blockquote class="home-bq">
                                            {{ comment.content|raw }}
                                        </blockquote>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        {{ '最近没有发布任何回复。' }}
                    {% endif %}

                </div>
            </div>

            <div class="panel panel-default">
                <div class="panel-heading">
                    {{ user.nickname }}的关注
                </div>
                <div class="panel-body">
                    {% if user.following is not empty %}
                        {% for fo in user.following %}
                            <li style="list-style: none;margin: 10px 0;display: inline-block;padding-right: 10px">
                                <a data-pjax href="{{ path('user_home', {username: fo.username}) }}">
                                    <img src="{{ fo.avatar }}" alt="" width="25" height="25" style="border-radius: 50%">
                                    {{ fo.nickname }}
                                </a>
                            </li>
                        {% endfor %}
                    {% else %}
                        {{ user.nickname }}比较高冷😌，目前没有关注任何人。
                    {% endif %}
                </div>
            </div>

            <div class="panel panel-default">
                <div class="panel-heading">
                    {{ user.nickname }}的粉丝
                </div>
                <div class="panel-body">
                    {% if user.followers is not empty %}
                        {% for fo in user.followers %}
                            <li style="list-style: none;margin: 10px 0;display: inline-block;padding-right: 10px">
                                <a data-pjax href="{{ path('user_home', {username: fo.username}) }}">
                                    <img src="{{ fo.avatar }}" alt="" width="25" height="25" style="border-radius: 50%">
                                    {{ fo.nickname }}
                                </a>
                            </li>
                        {% endfor %}
                    {% else %}
                        名声不佳，没有任何粉丝╮(╯_╰)╭
                    {% endif %}

                </div>
            </div>
        </div>
    </div>

    <script>
        $(function () {
            $(document).off('click', '#follow-user');
            $(document).on('click', '#follow-user', function () {
                $.ajax({
                    method: 'POST',
                    url: '{{ path("follow_user") }}',
                    data: {username: '{{ user.username }}'},
                    success: function (data) {
                        if (!data.ret) {
                            bootoast({
                                message: data.msg,
                                type: 'warning',
                                position: 'top-center',
                                icon: undefined,
                                timeout: 3,
                                animationDuration: 300,
                                dismissable: true
                            });
                        } else {
                            $.pjax.reload('.content-body', {
                                fragment: '.content-body',                          //来源也的ID
                                timeout: 200000000,
                                show: 'fade',
                                cache: true,  //是否使用缓存
                                push: true,
                                replace: true
                                //scrollTo: 250,
                            })
                        }
                    }
                })
            });

            $(document).off('click', '#send-message');
            $(document).on('click', '#send-message', function () {
                var $this = $(this);
                $this.button('loading');

                $.ajax({
                    method: 'POST',
                    url: '{{ path("send_message") }}',
                    data: {content: $('#message-text').val(), to: '{{ user.username }}'},
                    success: function () {
                        alert('发送成功');
                        $this.button('reset');
                        $('#message-text').val('');
                        $('#exampleModal').modal('hide');
                    }
                });
            });
        })
    </script>


{% endblock %}